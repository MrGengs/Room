<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR-Room</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/networked-aframe@0.14.0/dist/networked-aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.5.0/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-gltf-model-plus@1.0.0/dist/gltf-model-plus.min.js"></script>
    <script>
      window.uiSettings = {
        showRandomAvatarButton: true,
        showDieButton: true,
      };
    </script>
    <script src="/dist/components.js"></script>
    <script defer src="/dist/ui.js"></script>
    <style>
      .character-selection {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .character-option {
        width: 200px;
        height: 250px;
        margin: 20px;
        background: #333;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
      }
      .character-option:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
      }
      .character-option img {
        width: 150px;
        height: 150px;
        object-fit: contain;
      }
      .character-option h3 {
        color: white;
        margin: 10px 0;
      }
      .characters-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 800px;
      }
      .title {
        color: white;
        font-size: 2.5em;
        margin-bottom: 30px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- Character Selection Overlay -->
    <div id="character-selection" class="character-selection">
      <h1 class="title">PILIH KARAKTER ANDA</h1>
      <div class="characters-container">
        <div class="character-option" onclick="selectCharacter('male')">
          <img src="https://cdn.glitch.global/3e6e78f9-b796-4cf3-8451-2fcba6103a3c/avatar-male.png?v=1711641103935" alt="Male Character">
          <h3>Laki-laki</h3>
        </div>
        <div class="character-option" onclick="selectCharacter('female')">
          <img src="https://cdn.glitch.global/3e6e78f9-b796-4cf3-8451-2fcba6103a3c/avatar-female.png?v=1711641103935" alt="Female Character">
          <h3>Perempuan</h3>
        </div>
      </div>
    </div>

    <a-scene
      light="defaultLightsEnabled:false"
      renderer="stencil:true"
      networked-scene="
        connectOnLoad: false;
        room: lobby;
        debug: true;
        adapter: wseasyrtc;
        audio: false;
        video: false;"
      shadow="type: pcfsoft"
      gltf-model="meshoptDecoderPath:https://unpkg.com/meshoptimizer@0.19.0/meshopt_decoder.js"
      raycaster="far: 100; objects: .clickable,[link];"
      cursor="rayOrigin: mouse"
    >
      <!-- Assets -->
      <a-assets>
        <img id="thumbScene1" crossorigin="anonymous" src="https://cdn.aframe.io/link-traversal/thumbs/forest.png" />
        <template id="avatar-template">
          <a-entity player-info>
            <a-entity class="model">
              <a-text class="nametag" align="center" value="?" position="0 2.1 0" scale=".5 .5 .5"></a-text>
            </a-entity>
            <a-entity class="camera" position="0 1.6 0"></a-entity>
          </a-entity>
        </template>
      </a-assets>

      <!-- 
        Environment and Navigation. 
        For better performance, the nav-mesh should be a simplified version of the visual model.
        Here, we are using the same model for both.
      -->
      <a-gltf-model id="world-nav-mesh" src="assets/world.glb" nav-mesh class="collidable"></a-gltf-model>

      <!-- Welcome Text -->
      <a-text value="Selamat Datang Di AR-Room" align="center" position="0 2 -4" scale="1.5 1.5 1.5"></a-text>

      <!-- Portals -->
      <!-- Portal 1 -->
      <a-link
        change-room="on:obbcollisionstarted;room:scene1;url:scene1.html"
        link="on:click"
        href="scene1.html"
        title="Go To World 1"
        image="#thumbScene1"
        position="3 1.6 -5"
        class="clickable"
        event-set__mouseenter="material.opacity: 0.8"
        event-set__mouseleave="material.opacity: 0.6"
      >
        <a-box position="0 0 0.5" obb-collider visible="false"></a-box>
      </a-link>
      
      <!-- Portal 2 -->
      <a-link
        change-room="on:obbcollisionstarted;room:scene2;url:scene2.html"
        link="on:click"
        href="scene2.html"
        title="Go To World 2"
        image="#thumbScene1"
        position="-3 1.6 -5"
        class="clickable"
        event-set__mouseenter="material.opacity: 0.8"
        event-set__mouseleave="material.opacity: 0.6"
      >
        <a-box position="0 0 0.5" obb-collider visible="false"></a-box>
      </a-link>

      <!-- Environment -->
      <a-entity id="scene">
        <a-gltf-model src="assets/world.glb" position="0 0.2 0" scale="1 1 1" rotation="0 0 0"></a-gltf-model>
        <a-box class="collidable" position="0 0 0" width="20" height="0.1" depth="20" visible="false"></a-box>
        <a-plane class="ground" position="0 0 0" rotation="-90 0 0" width="100" height="100" visible="true"></a-plane>
        <a-entity light="type:ambient;intensity:0.5"></a-entity>
      </a-entity>

      <!-- Player -->
      <a-entity
        id="rig"
        collider
        movement-controls="fly:false;"
        spawn-in-circle="radius:1"
        networked="template:#avatar-template;attachTemplateToLocal:false"
        player-info
      >
        <a-entity id="player" class="camera" camera position="0 1.6 0" look-controls>
          <a-box obb-collider visible="false" height="0.4" depth="0.4" width="0.4"></a-box>
          <!-- Ring cursor for better interaction -->
          <a-entity
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.018; radiusOuter: 0.025"
            material="shader: flat; opacity: 0.9"
            cursor="fuse: true; fuseTimeout: 1200"
            raycaster="objects: .clickable; far: 20;"
            animation__fuse="property: scale; startEvents: fusing; from: 1 1 1; to: 0.2 0.2 0.2; dur: 1200; easing: linear"
            animation__reset="property: scale; startEvents: mouseleave; to: 1 1 1; dur: 120">
          </a-entity>
        </a-entity>
        <a-entity id="left-hand" networked-hand-controls="hand: left" laser-controls="hand: left"></a-entity>
        <a-entity id="right-hand" networked-hand-controls="hand:right" laser-controls="hand: right"></a-entity>
      </a-entity>
    </a-scene>

    <script>
      // Function to handle character selection
      function selectCharacter(character) {
        // Store the selected character
        localStorage.setItem('selectedCharacter', character);
        
        // Hide character selection
        document.getElementById('character-selection').style.display = 'none';
        
        // Show the main scene
        const scene = document.getElementById('main-scene');
        scene.style.display = 'block';
        
        // If using A-Frame, we need to initialize the scene
        if (scene.hasLoaded) {
          scene.emit('loaded');
        } else {
          scene.addEventListener('loaded', function onLoad() {
            scene.emit('loaded');
            scene.removeEventListener('loaded', onLoad);
          });
        }
      }

      // Check if character is already selected
      document.addEventListener('DOMContentLoaded', function() {
        const selectedCharacter = localStorage.getItem('selectedCharacter');
        if (selectedCharacter) {
          document.getElementById('character-selection').style.display = 'none';
          document.getElementById('main-scene').style.display = 'block';
        }
      });
    </script>
  </body>
</html>
